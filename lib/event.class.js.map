{"version":3,"sources":["../src/event.class.js"],"names":["Event","config","id","title","since","till","generatorId","color","undefined","icon","image","categoryId","tags","note","repeats","sequels","virtual","repeated","priority","overlap","internal","external","getPublicObject","offsetDate","date","scale","step","offsetYear","offsetMonth","offsetDay","Error","getRange","evts","reduce","range","e","int","getRepeats","_since","_till","qSince","qTill","events","forEach","pattern","index","times","round","cursor","cycle","concat","length","query","getSequels","sequel","sequelDates","offset","realSequel","collides","event","qEvent","collisions","handleOverlaps","_events","parallels","filter","evt","sort","a","b","items","conflicts","master","slaves","slice","trimmedSlaves","map","slave","collision","includes","Object","assign","_output","output","qsince","qtill","exports"],"mappings":"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","file":"event.class.js","sourcesContent":["const Event = function Event(config) {\n  const id = config.id;\n  const title = config.title;\n  const since = config.since;\n  const till = config.till || config.since;\n  const generatorId = config.generatorId || 'coripo.coripo.generator.handmade';\n  const color = config.color || undefined;\n  const icon = config.icon || undefined;\n  const image = config.image || undefined;\n  const categoryId = config.categoryId || undefined;\n  const tags = config.tags || [];\n  const note = config.note || '';\n  const repeats = config.repeats || [];\n  const sequels = config.sequels || [];\n  const virtual = config.virtual || false;\n  const repeated = config.repeated || false;\n  const priority = config.priority || 0;\n  const overlap = {\n    internal: ((config.overlap || {}).internal || 'allow'),\n    external: ((config.overlap || {}).external || 'allow'),\n  };\n  let getPublicObject;\n\n  const offsetDate = (date, scale, step) => {\n    switch (scale) {\n      case 'year': {\n        return date.offsetYear(step);\n      }\n      case 'month': {\n        return date.offsetMonth(step);\n      }\n      case 'day': {\n        return date.offsetDay(step);\n      }\n      default: {\n        throw new Error('Invalid scale string for offsetDate method');\n      }\n    }\n  };\n\n  const getRange = evts => evts.reduce((range, e) => ({\n    since: e.since.int() < range.since.int() ? e.since : range.since,\n    till: e.till.int() > range.till.int() ? e.till : range.till,\n  }), { since: evts[0].since, till: evts[0].till });\n\n  const getRepeats = (_since, _till) => {\n    const qSince = (_till.int() <= _since.int()) ? _till : _since;\n    const qTill = (_since.int() >= _till.int()) ? _since : _till;\n    let events = [];\n\n    repeats.forEach((pattern, index) => {\n      let times = pattern.times;\n      let round = 1;\n      let cursor = { since, till };\n      let range = { since, till };\n      /*\n        im not sure if this loop always does the job right\n        but i cant put more time on it for now\n      */\n      do {\n        cursor = {\n          since: offsetDate(cursor.since, pattern.cycle, pattern.step),\n          till: offsetDate(cursor.till, pattern.cycle, pattern.step),\n        };\n        range = {\n          since: offsetDate(range.since, pattern.cycle, pattern.step),\n          till: offsetDate(range.till, pattern.cycle, pattern.step),\n        };\n        if (range.since.int() >= qSince.int()) {\n          events = events.concat((new Event({\n            id,\n            generatorId,\n            virtual: true,\n            repeated: true,\n            overlap,\n            priority: priority + (round * (index + 1) * (sequels.length + 1)),\n            title,\n            color,\n            note,\n            sequels,\n            since: cursor.since,\n            till: cursor.till,\n          })).query(qSince, qTill, 'event[]'));\n        }\n        round += 1;\n        times -= 1;\n      } while (times !== 0 && range.since.int() <= qTill.int());\n    });\n    return events;\n  };\n\n  const getSequels = (_since, _till) => {\n    const qSince = (_till.int() <= _since.int()) ? _till : _since;\n    const qTill = (_since.int() >= _till.int()) ? _since : _till;\n    let events = [];\n\n    sequels.forEach((sequel, index) => {\n      const sequelDates = {\n        since: offsetDate(since, sequel.since.scale, sequel.since.offset),\n        till: offsetDate(since, sequel.till.scale, sequel.till.offset),\n      };\n      const realSequel = new Event({\n        id,\n        generatorId,\n        virtual: true,\n        repeated,\n        overlap,\n        priority: priority + (index + 1),\n        title: sequel.title || title,\n        note: sequel.note || note,\n        color: sequel.color || color,\n        since: sequelDates.since,\n        till: sequelDates.till,\n      });\n      events = events.concat((realSequel).query(qSince, qTill, 'event[]'));\n    });\n    return events;\n  };\n\n  const collides = (event, _since, _till) => {\n    const qEvent = event || { since, till };\n    const qSince = (_till.int() <= _since.int()) ? _till : _since;\n    const qTill = (_since.int() >= _till.int()) ? _since : _till;\n    let collisions = [];\n    if (qSince.int() <= qEvent.since.int() && qTill.int() >= qEvent.since.int()) {\n      collisions = collisions.concat(['l']);\n    }\n    if (qSince.int() <= qEvent.till.int() && qTill.int() >= qEvent.till.int()) {\n      collisions = collisions.concat(['r']);\n    }\n    if (qSince.int() >= qEvent.since.int() && qTill.int() <= qEvent.till.int()) {\n      collisions = collisions.concat(['c']);\n    }\n    if (qSince.int() <= qEvent.since.int() && qTill.int() >= qEvent.till.int()) {\n      collisions = collisions.concat(['i']);\n    }\n    if (collisions.length) return collisions;\n    return false;\n  };\n\n  const handleOverlaps = (_events, _since, _till) => {\n    const events = _events;\n    if (overlap.internal === 'allow') return events;\n    if (overlap.internal === 'remove') {\n      return events.reduce((evts, event) => {\n        const parallels = evts\n          .filter(evt => evt.virtual && collides(event, evt.since, evt.till))\n          .sort((a, b) => b.priority - a.priority);\n        if (!parallels.length) return evts.concat([event]);\n        const items = evts\n          .filter(evt => !(evt.virtual && collides(event, evt.since, evt.till)));\n        return items.concat([parallels[0]]);\n      }, []);\n    }\n    if (overlap.internal === 'trim') {\n      return events.reduce((evts, event) => {\n        const parallels = evts.filter(evt => evt.virtual && collides(event, evt.since, evt.till));\n        if (!parallels.length) return evts.concat([event]);\n        let items = evts.filter(evt => !(evt.virtual && collides(event, evt.since, evt.till)));\n        const conflicts = parallels.concat([event]).sort((a, b) => b.priority - a.priority);\n        const master = conflicts[0];\n        const slaves = conflicts.slice(1);\n        items = items.concat([master]);\n        const trimmedSlaves = slaves.map((evt) => {\n          let slave = evt;\n          let collision = collides(slave, master.since, master.till);\n          while (collision) {\n            if (collision.includes('r')) {\n              slave = (new Event(Object.assign({}, slave, {\n                till: master.since.offsetDay(-1),\n              }))).query(_since, _till, 'event[]')[0];\n            } else if (collision.includes('l')) {\n              slave = (new Event(Object.assign({}, slave, {\n                since: master.till.offsetDay(1),\n              }))).query(_since, _till, 'event[]')[0];\n            }\n            collision = collides(slave, master.since, master.till);\n          }\n          return slave;\n        }).filter(evt => evt.till.int() - evt.since.int() >= 0);\n        return items.concat(trimmedSlaves);\n      }, []);\n    }\n\n    return events;\n  };\n\n  const query = (_since, _till, _output) => {\n    const output = _output || 'series';\n    let events = [].concat(collides(undefined, _since, _till) ? [getPublicObject()] : [])\n      .concat(getSequels(_since, _till))\n      .concat(getRepeats(_since, _till));\n    events = handleOverlaps(events, _since, _till)\n      .sort((a, b) => a.since.int() - b.since.int());\n    if (output === 'event[]') return events;\n    return {\n      generatorId: events.length ? events[0].generatorId : undefined,\n      overlap: events.length ? events[0].overlap : undefined,\n      events,\n      range: events.length ?\n        getRange(events\n          .concat((overlap.external.includes('forever')) ?\n            query(since.offsetYear(-10), till, 'event[]') : [])) :\n        undefined,\n    };\n  };\n\n  getPublicObject = () => ({\n    id,\n    generatorId,\n    virtual,\n    repeated,\n    priority,\n    overlap,\n    title,\n    color,\n    icon,\n    image,\n    categoryId,\n    tags,\n    note,\n    since,\n    till,\n    collides: (qsince, qtill) => collides(undefined, qsince, qtill),\n    query,\n  });\n\n  return getPublicObject();\n};\n\nexports.Event = Event;\n"]}