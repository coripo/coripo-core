{"version":3,"sources":["../src/event.class.js"],"names":["Event","config","id","title","since","till","generatorId","color","undefined","icon","image","categoryId","tags","note","repeats","sequels","virtual","repeated","priority","overlap","internal","external","getPublicObject","offsetDate","date","scale","step","offsetYear","offsetMonth","offsetDay","Error","getRepeats","_since","_till","qSince","int","qTill","events","forEach","pattern","index","times","round","cursor","cycle","concat","length","query","getSequels","sequel","sequelDates","offset","realSequel","collides","event","qEvent","collisions","handleOverlaps","_events","reduce","evts","parallels","filter","evt","sort","a","b","items","conflicts","master","slaves","slice","trimmedSlaves","map","slave","collision","includes","Object","assign","_output","output","range","e","qsince","qtill","exports"],"mappings":"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","file":"event.class.js","sourcesContent":["const Event = function Event(config) {\n  const id = config.id;\n  const title = config.title;\n  const since = config.since;\n  const till = config.till || config.since;\n  const generatorId = config.generatorId || 'coripo.coripo.generator.handmade';\n  const color = config.color || undefined;\n  const icon = config.icon || undefined;\n  const image = config.image || undefined;\n  const categoryId = config.categoryId || undefined;\n  const tags = config.tags || [];\n  const note = config.note || '';\n  const repeats = config.repeats || [];\n  const sequels = config.sequels || [];\n  const virtual = config.virtual || false;\n  const repeated = config.repeated || false;\n  const priority = config.priority || 0;\n  const overlap = {\n    internal: ((config.overlap || {}).internal || 'allow'),\n    external: ((config.overlap || {}).external || 'allow'),\n  };\n  let getPublicObject;\n\n  const offsetDate = (date, scale, step) => {\n    switch (scale) {\n      case 'year': {\n        return date.offsetYear(step);\n      }\n      case 'month': {\n        return date.offsetMonth(step);\n      }\n      case 'day': {\n        return date.offsetDay(step);\n      }\n      default: {\n        throw new Error('Invalid scale string for offsetDate method');\n      }\n    }\n  };\n\n  const getRepeats = (_since, _till) => {\n    const qSince = (_till.int() <= _since.int()) ? _till : _since;\n    const qTill = (_since.int() >= _till.int()) ? _since : _till;\n    let events = [];\n\n    repeats.forEach((pattern, index) => {\n      let times = pattern.times;\n      let round = 1;\n      let cursor = {\n        since: offsetDate(since, pattern.cycle, pattern.step),\n        till: offsetDate(till, pattern.cycle, pattern.step),\n      };\n      while (times !== 0 && cursor.since.int() <= qTill.int()) {\n        if (cursor.since.int() >= qSince.int()) {\n          events = events.concat((new Event({\n            id,\n            generatorId,\n            virtual: true,\n            repeated: true,\n            overlap,\n            priority: priority + (round * (index + 1) * (sequels.length + 1)),\n            title,\n            color,\n            note,\n            sequels,\n            since: cursor.since,\n            till: cursor.till,\n          })).query(qSince, qTill, 'event[]'));\n        }\n        cursor = {\n          since: offsetDate(cursor.since, pattern.cycle, pattern.step),\n          till: offsetDate(cursor.till, pattern.cycle, pattern.step),\n        };\n        round += 1;\n        times -= 1;\n      }\n    });\n    return events;\n  };\n\n  const getSequels = (_since, _till) => {\n    const qSince = (_till.int() <= _since.int()) ? _till : _since;\n    const qTill = (_since.int() >= _till.int()) ? _since : _till;\n    let events = [];\n\n    sequels.forEach((sequel, index) => {\n      const sequelDates = {\n        since: offsetDate(since, sequel.since.scale, sequel.since.offset),\n        till: offsetDate(since, sequel.till.scale, sequel.till.offset),\n      };\n      const realSequel = new Event({\n        id,\n        generatorId,\n        virtual: true,\n        repeated,\n        overlap,\n        priority: priority + (index + 1),\n        title: sequel.title || title,\n        note: sequel.note || note,\n        color: sequel.color || color,\n        since: sequelDates.since,\n        till: sequelDates.till,\n      });\n      events = events.concat((realSequel).query(qSince, qTill, 'event[]'));\n    });\n    return events;\n  };\n\n  const collides = (event, _since, _till) => {\n    const qEvent = event || { since, till };\n    const qSince = (_till.int() <= _since.int()) ? _till : _since;\n    const qTill = (_since.int() >= _till.int()) ? _since : _till;\n    let collisions = [];\n    if (qSince.int() <= qEvent.since.int() && qTill.int() >= qEvent.since.int()) {\n      collisions = collisions.concat(['l']);\n    }\n    if (qSince.int() <= qEvent.till.int() && qTill.int() >= qEvent.till.int()) {\n      collisions = collisions.concat(['r']);\n    }\n    if (qSince.int() >= qEvent.since.int() && qTill.int() <= qEvent.till.int()) {\n      collisions = collisions.concat(['c']);\n    }\n    if (collisions.length) return collisions;\n    return false;\n  };\n\n  const handleOverlaps = (_events, _since, _till) => {\n    const events = _events;\n    if (overlap.internal === 'allow') return events;\n    if (overlap.internal === 'remove') {\n      return events.reduce((evts, event) => {\n        const parallels = evts\n          .filter(evt => evt.virtual && collides(event, evt.since, evt.till))\n          .sort((a, b) => b.priority - a.priority);\n        if (!parallels.length) return evts.concat([event]);\n        const items = evts\n          .filter(evt => !(evt.virtual && collides(event, evt.since, evt.till)));\n        return items.concat([parallels[0]]);\n      }, []);\n    }\n    if (overlap.internal === 'trim') {\n      return events.reduce((evts, event) => {\n        const parallels = evts.filter(evt => evt.virtual && collides(event, evt.since, evt.till));\n        if (!parallels.length) return evts.concat([event]);\n        let items = evts.filter(evt => !(evt.virtual && collides(event, evt.since, evt.till)));\n        const conflicts = parallels.concat([event]).sort((a, b) => b.priority - a.priority);\n        const master = conflicts[0];\n        const slaves = conflicts.slice(1);\n        items = items.concat([master]);\n        const trimmedSlaves = slaves.map((evt) => {\n          let slave = evt;\n          let collision = collides(slave, master.since, master.till);\n          while (collision) {\n            if (collision.includes('r')) {\n              slave = (new Event(Object.assign({}, slave, {\n                till: master.since.offsetDay(-1),\n              }))).query(_since, _till, 'event[]')[0];\n            } else if (collision.includes('l')) {\n              slave = (new Event(Object.assign({}, slave, {\n                since: master.till.offsetDay(1),\n              }))).query(_since, _till, 'event[]')[0];\n            }\n            collision = collides(slave, master.since, master.till);\n          }\n          return slave;\n        }).filter(evt => evt.till.int() - evt.since.int() >= 0);\n        return items.concat(trimmedSlaves);\n      }, []);\n    }\n\n    return events;\n  };\n\n  const query = (_since, _till, _output) => {\n    const output = _output || 'series';\n    let events = [].concat(collides(undefined, _since, _till) ? [getPublicObject()] : [])\n      .concat(getSequels(_since, _till))\n      .concat(getRepeats(_since, _till));\n    events = handleOverlaps(events, _since, _till)\n      .sort((a, b) => a.since.int() - b.since.int());\n    if (output === 'event[]') return events;\n    return {\n      generatorId: events.length ? events[0].generatorId : undefined,\n      overlap: events.length ? events[0].overlap : undefined,\n      events,\n      range: events.length ? (evts => evts\n        .concat((overlap.external.includes('forever')) ?\n          query(since.offsetYear(-10), till, 'event[]') : [])\n        .reduce((range, e) => ({\n          since: e.since.int() < range.since.int() ? e.since : range.since,\n          till: e.till.int() > range.till.int() ? e.till : range.till,\n        }), {\n          since: evts[0].since,\n          till: evts[0].till,\n        })\n      )(events) : undefined,\n    };\n  };\n\n  getPublicObject = () => ({\n    id,\n    generatorId,\n    virtual,\n    repeated,\n    priority,\n    overlap,\n    title,\n    color,\n    icon,\n    image,\n    categoryId,\n    tags,\n    note,\n    since,\n    till,\n    collides: (qsince, qtill) => collides(undefined, qsince, qtill),\n    query,\n  });\n\n  return getPublicObject();\n};\n\nexports.Event = Event;\n"]}