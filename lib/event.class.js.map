{"version":3,"sources":["../src/event.class.js"],"names":["Event","config","dna","id","title","since","till","generatorId","color","undefined","icon","image","categoryId","tags","note","repeats","sequels","virtual","repeated","priority","overlap","internal","external","getPublicObject","getPrivateObject","collides","offsetDate","date","scale","step","offsetYear","offsetMonth","offsetDay","Error","event","_since","_till","qs","int","qt","es","et","collisions","concat","length","getRange","evts","reduce","range","e","getRepeats","qSince","qTill","events","pattern","index","times","round","cursor","cycle","Object","assign","query","getSequels","sequel","sequelDates","offset","realSequel","handleOverlaps","_events","parallels","filter","evt","sort","a","b","items","conflicts","master","slaves","slice","trimmedSlaves","map","slave","collision","includes","_output","output","qsince","qtill","module","exports"],"mappings":"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","file":"event.class.js","sourcesContent":["const Event = function Event(config) {\n  const dna = config.dna;\n  const id = config.id;\n  const title = config.title;\n  const since = config.since;\n  const till = config.till || config.since;\n  const generatorId = config.generatorId || 'coripo.coripo.generator.handmade';\n  const color = config.color || undefined;\n  const icon = config.icon || undefined;\n  const image = config.image || undefined;\n  const categoryId = config.categoryId || undefined;\n  const tags = config.tags || [];\n  const note = config.note || '';\n  const repeats = config.repeats || [];\n  const sequels = config.sequels || [];\n  const virtual = config.virtual || false;\n  const repeated = config.repeated || false;\n  const priority = config.priority || 0;\n  const overlap = {\n    internal: ((config.overlap || {}).internal || 'allow'),\n    external: ((config.overlap || {}).external || 'allow'),\n  };\n  let getPublicObject = () => { };\n  let getPrivateObject = () => { };\n  let collides = () => { };\n\n  const offsetDate = (date, scale, step) => {\n    switch (scale) {\n      case 'year': {\n        return date.offsetYear(step);\n      }\n      case 'month': {\n        return date.offsetMonth(step);\n      }\n      case 'day': {\n        return date.offsetDay(step);\n      }\n      default: {\n        throw new Error('Invalid scale string for offsetDate method');\n      }\n    }\n  };\n\n  collides = (event, _since, _till) => {\n    const qs = (_till.int() <= _since.int() ? _till : _since).int();\n    const qt = (_since.int() >= _till.int() ? _since : _till).int();\n    const es = (event || { since, till }).since.int();\n    const et = (event || { since, till }).till.int();\n    const collisions = []\n      .concat((qs <= es && qt >= es) ? ['left'] : [])\n      .concat((qs <= et && qt >= et) ? ['right'] : [])\n      .concat((qs > es && qt < et) ? ['inside'] : [])\n      .concat((qs < es && qt > et) ? ['outside'] : []);\n    if (collisions.length) return collisions;\n    return false;\n  };\n\n  const getRange = evts => evts.reduce((range, e) => ({\n    since: e.since.int() < range.since.int() ? e.since : range.since,\n    till: e.till.int() > range.till.int() ? e.till : range.till,\n  }), { since: evts[0].since, till: evts[0].till });\n\n  const getRepeats = (_since, _till) => {\n    const qSince = (_till.int() <= _since.int()) ? _till : _since;\n    const qTill = (_since.int() >= _till.int()) ? _since : _till;\n\n    return repeats.reduce((events, pattern, index) => {\n      let evts = [];\n      let times = pattern.times;\n      let round = 1;\n      let cursor = { since, till };\n      let range = { since, till };\n\n      do {\n        cursor = {\n          since: offsetDate(cursor.since, pattern.cycle, pattern.step),\n          till: offsetDate(cursor.till, pattern.cycle, pattern.step),\n        };\n        range = {\n          since: offsetDate(range.since, pattern.cycle, pattern.step),\n          till: offsetDate(range.till, pattern.cycle, pattern.step),\n        };\n        evts = evts.concat(new Event(Object.assign({}, getPrivateObject(), {\n          virtual: true,\n          repeated: true,\n          priority: priority + (round * (index + 1) * (sequels.length + 1)),\n          since: cursor.since,\n          till: cursor.till,\n          repeats: [],\n        })).query(qSince, qTill, 'event[]'));\n        round += 1;\n        times -= 1;\n      } while (times !== 0 && range.since.int() <= qTill.int());\n      return events.concat(evts);\n    }, []);\n  };\n\n  const getSequels = (_since, _till) => {\n    const qSince = (_till.int() <= _since.int()) ? _till : _since;\n    const qTill = (_since.int() >= _till.int()) ? _since : _till;\n\n    return sequels.reduce((events, sequel, index) => {\n      const sequelDates = {\n        since: offsetDate(since, sequel.since.scale, sequel.since.offset),\n        till: offsetDate(since, sequel.till.scale, sequel.till.offset),\n      };\n      if ((!sequel.repeats || !sequel.repeats.length) &&\n        !collides({\n          since: sequelDates.since,\n          till: sequelDates.till,\n        }, qSince, qTill)) return events;\n\n      const realSequel = new Event(Object.assign({}, getPrivateObject(), {\n        virtual: true,\n        priority: priority + (index + 1),\n        title: sequel.title,\n        note: sequel.note,\n        color: sequel.color,\n        since: sequelDates.since,\n        till: sequelDates.till,\n        repeats: sequel.repeats,\n        sequels: [],\n      }));\n      return events.concat((realSequel).query(qSince, qTill, 'event[]'));\n    }, []);\n  };\n\n  const handleOverlaps = (_events, _since, _till) => {\n    const events = _events;\n    if (overlap.internal === 'allow') return events;\n    if (overlap.internal === 'remove') {\n      return events.reduce((evts, event) => {\n        const parallels = evts\n          .filter(evt => evt.virtual && collides(event, evt.since, evt.till))\n          .sort((a, b) => b.priority - a.priority);\n        if (!parallels.length) return evts.concat([event]);\n        const items = evts\n          .filter(evt => !(evt.virtual && collides(event, evt.since, evt.till)));\n        return items.concat([parallels[0]]);\n      }, []);\n    }\n    if (overlap.internal === 'trim') {\n      return events.reduce((evts, event) => {\n        const parallels = evts.filter(evt => evt.virtual && collides(event, evt.since, evt.till));\n        if (!parallels.length) return evts.concat([event]);\n        let items = evts.filter(evt => !(evt.virtual && collides(event, evt.since, evt.till)));\n        const conflicts = parallels.concat([event]).sort((a, b) => b.priority - a.priority);\n        const master = conflicts[0];\n        const slaves = conflicts.slice(1);\n        items = items.concat([master]);\n        const trimmedSlaves = slaves.map((evt) => {\n          let slave = evt;\n          let collision = collides(slave, master.since, master.till);\n          while (collision) {\n            if (collision.includes('right')) {\n              slave = (new Event(Object.assign({}, slave, {\n                till: master.since.offsetDay(-1),\n              }))).query(_since, _till, 'event[]')[0];\n            } else if (collision.includes('left')) {\n              slave = (new Event(Object.assign({}, slave, {\n                since: master.till.offsetDay(1),\n              }))).query(_since, _till, 'event[]')[0];\n            }\n            collision = collides(slave, master.since, master.till);\n          }\n          return slave;\n        }).filter(evt => evt.till.int() - evt.since.int() >= 0);\n        return items.concat(trimmedSlaves);\n      }, []);\n    }\n\n    return events;\n  };\n\n  const query = (_since, _till, _output) => {\n    const output = _output || 'series';\n    let events = [].concat(collides(undefined, _since, _till) ? [getPublicObject()] : [])\n      .concat(getSequels(_since, _till))\n      .concat(getRepeats(_since, _till));\n    events = handleOverlaps(events, _since, _till)\n      .sort((a, b) => a.since.int() - b.since.int());\n    if (output === 'event[]') return events;\n    return {\n      generatorId: events.length ? events[0].generatorId : undefined,\n      overlap: events.length ? events[0].overlap : undefined,\n      events,\n      range: events.length ?\n        getRange(events\n          .concat((overlap.external.includes('forever')) ?\n            query(since.offsetYear(-10), till, 'event[]') : [])) :\n        undefined,\n    };\n  };\n\n  getPublicObject = () => ({\n    dna,\n    id,\n    generatorId,\n    virtual,\n    repeated,\n    priority,\n    overlap,\n    title,\n    color,\n    icon,\n    image,\n    categoryId,\n    tags,\n    note,\n    since,\n    till,\n    collides: (qsince, qtill) => collides(undefined, qsince, qtill),\n    query,\n  });\n\n  getPrivateObject = () => Object.assign({}, getPublicObject(), {\n    sequels,\n    repeats,\n  });\n\n  return getPublicObject();\n};\n\nmodule.exports = Event;\n"]}