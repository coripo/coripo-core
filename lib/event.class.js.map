{"version":3,"sources":["../src/event.class.js"],"names":["Event","config","id","title","since","till","generatorId","color","undefined","icon","image","categoryId","tags","note","repeats","sequels","virtual","repeated","priority","overlap","internal","external","getPublicObject","getPrivateObject","collides","offsetDate","date","scale","step","offsetYear","offsetMonth","offsetDay","Error","getEstimatedRange","event","getRange","evts","reduce","range","e","int","getRepeats","_since","_till","qSince","qTill","events","pattern","index","times","round","cursor","cycle","concat","Object","assign","length","query","getSequels","sequel","sequelDates","offset","realSequel","qs","qt","es","et","collisions","handleOverlaps","_events","parallels","filter","evt","sort","a","b","items","conflicts","master","slaves","slice","trimmedSlaves","map","slave","collision","includes","_output","output","qsince","qtill","exports"],"mappings":"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","file":"event.class.js","sourcesContent":["const Event = function Event(config) {\n  const id = config.id;\n  const title = config.title;\n  const since = config.since;\n  const till = config.till || config.since;\n  const generatorId = config.generatorId || 'coripo.coripo.generator.handmade';\n  const color = config.color || undefined;\n  const icon = config.icon || undefined;\n  const image = config.image || undefined;\n  const categoryId = config.categoryId || undefined;\n  const tags = config.tags || [];\n  const note = config.note || '';\n  const repeats = config.repeats || [];\n  const sequels = config.sequels || [];\n  const virtual = config.virtual || false;\n  const repeated = config.repeated || false;\n  const priority = config.priority || 0;\n  const overlap = {\n    internal: ((config.overlap || {}).internal || 'allow'),\n    external: ((config.overlap || {}).external || 'allow'),\n  };\n  let getPublicObject = () => { };\n  let getPrivateObject = () => { };\n  let collides = () => { };\n\n  const offsetDate = (date, scale, step) => {\n    switch (scale) {\n      case 'year': {\n        return date.offsetYear(step);\n      }\n      case 'month': {\n        return date.offsetMonth(step);\n      }\n      case 'day': {\n        return date.offsetDay(step);\n      }\n      default: {\n        throw new Error('Invalid scale string for offsetDate method');\n      }\n    }\n  };\n\n  const getEstimatedRange = (event) => {\n\n  };\n\n  const getRange = evts => evts.reduce((range, e) => ({\n    since: e.since.int() < range.since.int() ? e.since : range.since,\n    till: e.till.int() > range.till.int() ? e.till : range.till,\n  }), { since: evts[0].since, till: evts[0].till });\n\n  const getRepeats = (_since, _till) => {\n    const qSince = (_till.int() <= _since.int()) ? _till : _since;\n    const qTill = (_since.int() >= _till.int()) ? _since : _till;\n\n    return repeats.reduce((events, pattern, index) => {\n      let evts = [];\n      let times = pattern.times;\n      let round = 1;\n      let cursor = { since, till };\n      let range = { since, till };\n\n      do {\n        cursor = {\n          since: offsetDate(cursor.since, pattern.cycle, pattern.step),\n          till: offsetDate(cursor.till, pattern.cycle, pattern.step),\n        };\n        range = {\n          since: offsetDate(range.since, pattern.cycle, pattern.step),\n          till: offsetDate(range.till, pattern.cycle, pattern.step),\n        };\n        evts = evts.concat(new Event(Object.assign({}, getPrivateObject(), {\n          virtual: true,\n          repeated: true,\n          priority: priority + (round * (index + 1) * (sequels.length + 1)),\n          since: cursor.since,\n          till: cursor.till,\n          repeats: [],\n        })).query(qSince, qTill, 'event[]'));\n        round += 1;\n        times -= 1;\n      } while (times !== 0 && range.since.int() <= qTill.int());\n      return events.concat(evts);\n    }, []);\n  };\n\n  const getSequels = (_since, _till) => {\n    const qSince = (_till.int() <= _since.int()) ? _till : _since;\n    const qTill = (_since.int() >= _till.int()) ? _since : _till;\n\n    return sequels.reduce((events, sequel, index) => {\n      const sequelDates = {\n        since: offsetDate(since, sequel.since.scale, sequel.since.offset),\n        till: offsetDate(since, sequel.till.scale, sequel.till.offset),\n      };\n      if ((!sequel.repeats || !sequel.repeats.length) &&\n        !collides({\n          since: sequelDates.since,\n          till: sequelDates.till,\n        }, qSince, qTill)) return events;\n\n      const realSequel = new Event(Object.assign({}, getPrivateObject(), {\n        virtual: true,\n        priority: priority + (index + 1),\n        title: sequel.title,\n        note: sequel.note,\n        color: sequel.color,\n        since: sequelDates.since,\n        till: sequelDates.till,\n        repeats: sequel.repeats,\n        sequels: [],\n      }));\n      return events.concat((realSequel).query(qSince, qTill, 'event[]'));\n    }, []);\n  };\n\n  collides = (event, _since, _till) => {\n    const qs = (_till.int() <= _since.int() ? _till : _since).int();\n    const qt = (_since.int() >= _till.int() ? _since : _till).int();\n    const es = (event || { since, till }).since.int();\n    const et = (event || { since, till }).till.int();\n    const collisions = []\n      .concat((qs <= es && qt >= es) ? ['l'] : [])\n      .concat((qs <= et && qt >= et) ? ['r'] : [])\n      .concat((qs >= es && qt <= et) ? ['c'] : [])\n      .concat((qs <= es && qt >= et) ? ['i'] : []);\n    if (collisions.length) return collisions;\n    return false;\n  };\n\n  const handleOverlaps = (_events, _since, _till) => {\n    const events = _events;\n    if (overlap.internal === 'allow') return events;\n    if (overlap.internal === 'remove') {\n      return events.reduce((evts, event) => {\n        const parallels = evts\n          .filter(evt => evt.virtual && collides(event, evt.since, evt.till))\n          .sort((a, b) => b.priority - a.priority);\n        if (!parallels.length) return evts.concat([event]);\n        const items = evts\n          .filter(evt => !(evt.virtual && collides(event, evt.since, evt.till)));\n        return items.concat([parallels[0]]);\n      }, []);\n    }\n    if (overlap.internal === 'trim') {\n      return events.reduce((evts, event) => {\n        const parallels = evts.filter(evt => evt.virtual && collides(event, evt.since, evt.till));\n        if (!parallels.length) return evts.concat([event]);\n        let items = evts.filter(evt => !(evt.virtual && collides(event, evt.since, evt.till)));\n        const conflicts = parallels.concat([event]).sort((a, b) => b.priority - a.priority);\n        const master = conflicts[0];\n        const slaves = conflicts.slice(1);\n        items = items.concat([master]);\n        const trimmedSlaves = slaves.map((evt) => {\n          let slave = evt;\n          let collision = collides(slave, master.since, master.till);\n          while (collision) {\n            if (collision.includes('r')) {\n              slave = (new Event(Object.assign({}, slave, {\n                till: master.since.offsetDay(-1),\n              }))).query(_since, _till, 'event[]')[0];\n            } else if (collision.includes('l')) {\n              slave = (new Event(Object.assign({}, slave, {\n                since: master.till.offsetDay(1),\n              }))).query(_since, _till, 'event[]')[0];\n            }\n            collision = collides(slave, master.since, master.till);\n          }\n          return slave;\n        }).filter(evt => evt.till.int() - evt.since.int() >= 0);\n        return items.concat(trimmedSlaves);\n      }, []);\n    }\n\n    return events;\n  };\n\n  const query = (_since, _till, _output) => {\n    const output = _output || 'series';\n    let events = [].concat(collides(undefined, _since, _till) ? [getPublicObject()] : [])\n      .concat(getSequels(_since, _till))\n      .concat(getRepeats(_since, _till));\n    events = handleOverlaps(events, _since, _till)\n      .sort((a, b) => a.since.int() - b.since.int());\n    if (output === 'event[]') return events;\n    return {\n      generatorId: events.length ? events[0].generatorId : undefined,\n      overlap: events.length ? events[0].overlap : undefined,\n      events,\n      range: events.length ?\n        getRange(events\n          .concat((overlap.external.includes('forever')) ?\n            query(since.offsetYear(-10), till, 'event[]') : [])) :\n        undefined,\n    };\n  };\n\n  getPublicObject = () => ({\n    id,\n    generatorId,\n    virtual,\n    repeated,\n    priority,\n    overlap,\n    title,\n    color,\n    icon,\n    image,\n    categoryId,\n    tags,\n    note,\n    since,\n    till,\n    collides: (qsince, qtill) => collides(undefined, qsince, qtill),\n    query,\n  });\n\n  getPrivateObject = () => Object.assign({}, getPublicObject, {\n    sequels,\n    repeats,\n  });\n\n  return getPublicObject();\n};\n\nexports.Event = Event;\n"]}